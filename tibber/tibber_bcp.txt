package tibber

import (
	"context"
	"fmt"
	"log/slog"
	"sync"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5"
)

type TibberQueries interface {
	QueryUser(ctx context.Context, u *User) UserResponse
}

type querier struct {
	tq TibberQueries
}

func NewQuerier(q TibberQueries) *querier {
	return &querier{q}
}

func (q *querier) QueryUser(ctx context.Context, u *User) UserResponse {
	fmt.Println("server.QueryUser")
	return q.tq.QueryUser(ctx, u)
}

type Client struct {
	Querier         *querier
	APIClient       GQLClienter
	DBConn          *pgx.Conn
	Logger          *slog.Logger
	WebsocketClient *WebsocketClient
	Wg              *sync.WaitGroup
}

type SubscriptionId struct{}

func NewClient(q *querier, c GQLClienter, l *slog.Logger, w *WebsocketClient, wg *sync.WaitGroup) *Client {
	return &Client{
		Querier:         q,
		APIClient:       c,
		Logger:          l,
		WebsocketClient: w,
		Wg:              wg,
	}
}

// Query Tibber API
func (t *Client) QueryUser(ctx context.Context, u *User) UserResponse {
	return u.query(ctx, t)
}

func (t *Client) QueryConsumption(ctx context.Context, c *Consumption) HomeConsumptionResponse {
	return c.query(ctx, t)
}

func (t *Client) QueryWebsocketSubscriptionUrl(ctx context.Context, w *WebsocketSubscriptionUrl) WebsocketSubscriptionUrlResponse {
	return w.query(ctx, t)
}

func (t *Client) QueryPrice(ctx context.Context, p *Price) PriceResponse {
	return p.query(ctx, t)
}

// Subscribe to Tibber websocket
func (t *Client) Subscribe(ctx context.Context) {
	defer t.Wg.Done()
	sctx := context.WithValue(ctx, SubscriptionId{}, uuid.New().String())
	socketConnection(sctx, t)
}
